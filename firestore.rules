rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection - only read/write own user data
    match /users/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // Analyses collection - users can read/write their own analyses
    // This is the main collection for repository analysis persistence
    match /analyses/{analysisId} {
      allow create: if isAuthenticated() && 
                       isOwner(resource.data.userId) &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.repoUrl != null &&
                       request.resource.data.repoName != null;
      
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow update: if isAuthenticated() && 
                       isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId;
      
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // User Progress tracking - users can read/write their own progress
    match /userProgress/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // Quiz responses - users can read/write their own quiz data
    match /quizzes/{quizId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow read: if isAuthenticated() && 
                     isOwner(resource.data.userId);
      
      allow update, delete: if isAuthenticated() && 
                               isOwner(resource.data.userId);
    }

    // Learning Paths - users can read/write their own paths
    match /learningPaths/{pathId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow read: if isAuthenticated() && 
                     isOwner(resource.data.userId);
      
      allow update, delete: if isAuthenticated() && 
                               isOwner(resource.data.userId);
    }

    // Playbooks - public read, authenticated write
    match /playbooks/{playbookId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               isOwner(resource.data.createdBy);
    }

    // Cache for offline persistence - users can read/write their own cache
    match /cache/{userId}/{document=**} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
